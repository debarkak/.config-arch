//!wrt $BSPEC:{"icn":"apps/js","cpr":"Copyright (C) Windows 96 Team 2023.","dsc":"JS GUI REPL","frn":"JS GUI REPL","ver":1,"ssy":"gui"}

const{DialogCreator:DialogCreator,Theme:Theme,MenuBar:MenuBar}=w96.ui,{DomUtils:DomUtils}=w96.util;class JSGUIRepl extends WApplication{constructor(){super(),this.stats={errors:0}}async main(e){super.main(e);const t=this.createWindow({title:"JS REPL (Gui)",icon:await Theme.getIconUrl("apps/js","16x16"),taskbar:!0,bodyClass:"jsguirepl-app",initialHeight:400,initialWidth:520,body:'<div class="appbar"></div>\n            <div class="view w96-inset">\n                <div class="history"></div>\n                <div class="input">\n                    <input class="w96-textbox" type="text">\n                </div>\n            </div>\n            <footer class="w96-footer">\n                <div class="cell">\n                    0 errors\n                </div>\n            </footer>'},!0),s=t.getBodyContainer(),n=new MenuBar;n.addRoot("File",[{type:"normal",label:"Exit",onclick:()=>t.close()}]),n.addRoot("View",[{type:"normal",label:"Clear History (CTRL + L)",onclick:()=>this.clearConsole()}]),n.addRoot("Help",[{type:"normal",label:"About",onclick:()=>DialogCreator.alert('<span class="bold-noaa">JS REPL (Gui)</span><br>Version 1.0<br>',{title:"About JS REPL (Gui)",icon:"info"})}]),this.mainwnd=t,s.querySelector(".appbar").replaceWith(n.getMenuDiv()),this.setupInputBox(),t.show()}clearConsole(){const e=this.mainwnd.getBodyContainer().querySelector(".history");for(;e.firstChild;)e.removeChild(e.firstChild)}pushConsoleMessage(e,t){const s={type:"text",severity:"none",caller:"code",...e},n=DomUtils.mkElement("div",["line",`caller-${s.caller}`]);if("none"===s.severity);else n.classList.add(s.severity);"text"==s.type&&void 0!==t&&(n.innerText=t);const i=this.mainwnd.getBodyContainer().querySelector(".history");return i.appendChild(n),i.scrollTop=i.scrollHeight,n}setupInputBox(){const e=this.mainwnd.getBodyContainer(),t=e.querySelector("input"),s=e.querySelector(".history");t.addEventListener("keydown",(e=>{if(e.ctrlKey&&"l"==e.key)e.preventDefault(),this.clearConsole();else if("Enter"==e.key){if(""==t.value.trim())return;return this.pushConsoleMessage({caller:"user"},t.value),this.evaluate(t.value),s.scrollTop=s.scrollHeight,void(t.value="")}}))}formatObject(e,t){switch(typeof t){case"bigint":case"number":return void e.classList.add("js-number");case"string":return e.classList.add("js-string"),void(e.innerText=`"${e.innerText}"`);case"undefined":return e.classList.add("js-undefined"),void(e.innerText="undefined");case"symbol":return e.classList.add("js-symbol"),void(e.innerText="Symbol");case"boolean":return void e.classList.add("js-bool")}if(null===t)return e.classList.add("js-undefined"),void(e.innerText="null");if(t instanceof Array){let s="";if(t.length>200)s=`... large array (${t.length} items) ...`;else if(0==t.length)s="";else for(let e of t){let t=DomUtils.mkElement("span",[]);t.innerText="symbol"==typeof e?"Symbol":"function"==typeof e?"Æ’":"object"==typeof e?"{ . obj . }":e,this.formatObject(t,e),s+=t.outerHTML+", ",t=null}e.innerHTML=`[ ${s.substring(0,s.length-2)} ]`}}updateErrorCount(){const e=this.mainwnd.getBodyContainer();this.stats.errors++,e.querySelector(".w96-footer .cell").textContent=`${this.stats.errors} error${1===this.stats.errors?"":"s"}`}evaluate(text){try{const result=eval(text),msg=this.pushConsoleMessage({caller:"code"},"symbol"!=typeof result?result:"");this.formatObject(msg,result)}catch(e){const t=this.pushConsoleMessage({severity:"error",caller:"code"});if(t.classList.add("exception"),e instanceof Error){const s=DomUtils.mkElement("span",["name"]);s.innerText=`${e.name}: `;const n=DomUtils.mkElement("span",["message"]);n.innerText=`${e.message}`,t.appendChild(s),t.appendChild(n)}else{const s=DomUtils.mkElement("span",["message"]);s.innerText=`${e.message}`,t.appendChild(s)}this.updateErrorCount()}}}

return await WApplication.execAsync(new JSGUIRepl(), this.boxedEnv.args, this);