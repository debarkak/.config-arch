//!wrt $BSPEC:{"icn":"apps/mplayer","cpr":"Copyright (C) Windows 96 Team 2023.","dsc":"Media Player for Windows 96","frn":"MPlayer","ver":1,"ssy":"gui"}

function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:String(t)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var s=r.call(e,t||"default");if("object"!=typeof s)return s;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}class MPlayer_HTMLAudio{constructor(){this._player=new Audio,this._fileName=null,this._fileURL=null,this._hookEvents()}getVideoElement(){return null}_hookEvents(){this._player.onloadeddata=e=>{this.onloaded&&this.onloaded(e)},this._player.onplay=e=>{this.onplay&&this.onplay(e)},this._player.onpause=e=>{this.onpause&&this.onpause(e)},this._player.onended=e=>{this.onended&&this.onended(e)},this._player.onerror=e=>{this.onerror&&this.onerror(e)},this._player.ondurationchange=e=>{this.ondurationchange&&this.ondurationchange(this._player.duration,e)},this._player.ontimeupdate=e=>{this.ontimeupdate&&this.ontimeupdate(this._player.currentTime,e)},this._player.onvolumechange=e=>{this.onvolumechange&&this.onvolumechange(this._player.volume,e)}}load(e){if(!e)throw new Error("File to load has not been specified");return new Promise((async(t,r)=>{const s=FSUtil.getExtension(e).toLowerCase().substring(1);if(URL.revokeObjectURL(this._fileURL),!this.constructor.fileExtensions.includes(s))throw new Error("Unsupported file type: "+s);this._player.addEventListener("canplaythrough",t,{once:!0}),this._fileName=FSUtil.fname(e),this._fileURL=URL.createObjectURL(await FS.toBlob(e)),this._player.src=this._fileURL}))}play(){this._player.play()}pause(){this._player.pause()}stop(){this._player.pause(),this._player.currentTime=0}time(e){return"number"==typeof e&&(this._player.currentTime=e),this._player.currentTime}volume(e){return"number"==typeof e&&e<=1&&(this._player.volume=e),this._player.volume}duration(){return this._player.duration}getName(){return this._fileName}state(){return this._player.ended?3:this._player.paused&&0!==this._player.currentTime?2:this._player.paused?0:1}playbackRate(e){return e&&(this._player.playbackRate=e),this._player.playbackRate}unload(){this._player.pause(),this._player.removeAttribute("src"),this._player.load(),URL.revokeObjectURL(this._fileURL)}}_defineProperty(MPlayer_HTMLAudio,"backendName","HTML Audio"),_defineProperty(MPlayer_HTMLAudio,"fileExtensions",["mp3","ogg","flac","wav","opus"]);class MPlayer_HTMLVideo extends MPlayer_HTMLAudio{constructor(){super(),this._player=document.createElement("video"),this._hookEvents()}getVideoElement(){return this._player}}_defineProperty(MPlayer_HTMLVideo,"backendName","HTML Video"),_defineProperty(MPlayer_HTMLVideo,"fileExtensions",["mp4","webm","mov"]);const{OpenFileDialog:OpenFileDialog,Theme:Theme,DialogCreator:DialogCreator,MenuBar:MenuBar}=w96.ui;class MPlayerApplication extends WApplication{constructor(){super()}secondsToString(e){const t=Math.floor(e);let r=Math.floor(t/3600),s=Math.floor((t-3600*r)/60),i=t-3600*r-60*s;return r<10&&(r="0"+r),s<10&&(s="0"+s),i<10&&(i="0"+i),r+":"+s+":"+i}async loadResources(){this.resources={};for(let e in this.constructor.resources){let t=new Blob([await FS.readbin(this.constructor.resources[e])],{type:"image/png"});this.resources[e]=URL.createObjectURL(t)}}revokeResources(){for(let e in this.resources)URL.revokeObjectURL(this.resources[e])}async main(e){super.main(e),this.player=null,this.currentFile=null;try{await this.loadResources()}catch(e){return DialogCreator.alert("Failed to load media player icons.",{icon:"error",title:"Error"}),console.error("[Media Player]",e)}this.mainwnd=this.createWindow({title:"Media Player",icon:await Theme.getIconUrl("apps/mplayer","16x16"),body:`\n                <div class="mplayer-menubar"></div>\n                <div class="mplayer-main">\n                    <div class="mplayer-progress">\n                        <div class="mplayer-progress-bar">\n                            <div class="slider"></div>\n                        </div>\n                        <div class="mplayer-timestamps">\n                            <div class="ts ts-start"></div>\n                            <div class="ts ts-end"></div>\n                        </div>\n                    </div>\n                    <div class="w96-ui-inset-separator"></div>\n                    <div class="mplayer-buttons">\n                        <div class="mplayer-button-group">\n                            <button class="w96-button mplayer-play-pause" disabled><img src="${this.resources.play}"></button>\n                            <button class="w96-button mplayer-stop" disabled><img src="${this.resources.stop}"></button>\n                            <button class="w96-button mplayer-eject" disabled><img src="${this.resources.eject}"></button>\n                        </div>\n                        <div class="mplayer-button-group">\n                            <button class="w96-button mplayer-previous_mark" disabled><img src="${this.resources.previousMark}"></button>\n                            <button class="w96-button mplayer-rewind" disabled><img src="${this.resources.rewind}"></button>\n                            <button class="w96-button mplayer-fast_forward" disabled><img src="${this.resources.fastForward}"></button>\n                            <button class="w96-button mplayer-next_mark" disabled><img src="${this.resources.nextMark}"></button>\n                        </div>\n                        <div class="mplayer-button-group">\n                            <button class="w96-button mplayer-start_selection" disabled><img src="${this.resources.startSelection}"></button>\n                            <button class="w96-button mplayer-end_selection" disabled><img src="${this.resources.endSelection}"></button>\n                        </div>\n                        <input type="text" class="w96-textbox mplayer-status" readonly>\n                    </div>\n                </div>\n            `,minWidth:392,minHeight:111,initialWidth:392,initialHeight:111,taskbar:!0},!0),this.videownd=null;const t=this.mainwnd.getBodyContainer(),r=new MenuBar;if(this.statusBar=t.querySelector(".mplayer-status"),this.progressBar=t.querySelector(".mplayer-progress-bar"),this.thumb=t.querySelector(".mplayer-progress-bar>.slider"),this.progressBar.onmousedown=e=>{this.player&&(this.progMouseDown=!0,this._mouseMoveListener(e),this.thumb.style.background=`url(${this.resources.thumbActive})`)},this._mouseMoveListener=e=>{if(this.progMouseDown){let t=e.clientX-this.progressBar.getBoundingClientRect().left;t>this.progressBar.offsetWidth&&(t=this.progressBar.offsetWidth),this.player.time(t/this.progressBar.offsetWidth*this.player.duration())}},this._mouseUpListener=e=>{this.progMouseDown=!1,this.thumb.style.background=`url(${this.resources.thumb})`},document.body.addEventListener("mousemove",this._mouseMoveListener),document.body.addEventListener("mouseup",this._mouseUpListener),this.thumb.style.background=`url(${this.resources.thumb})`,this.buttons={playPause:t.querySelector(".mplayer-play-pause"),stop:t.querySelector(".mplayer-stop"),previousMark:t.querySelector(".mplayer-previous_mark"),rewind:t.querySelector(".mplayer-rewind"),fastForward:t.querySelector(".mplayer-fast_forward"),nextMark:t.querySelector(".mplayer-next_mark"),startSelection:t.querySelector(".mplayer-start_selection"),endSelection:t.querySelector(".mplayer-end_selection")},this.buttons.playPause.onclick=()=>{1!==this.player.state()?this.player.play():this.player.pause()},this.buttons.stop.onclick=()=>{this.player.stop()},this.buttons.previousMark.onclick=()=>{this.player.time(0)},this.buttons.fastForward.onclick=()=>{this.player.time(this.player.time()+this.player.duration()/16)},this.buttons.rewind.onclick=()=>{this.player.time(this.player.time()-this.player.duration()/16)},r.addRoot("File",[{type:"normal",label:"Open...",onclick:()=>{new OpenFileDialog("C:/user",this.constructor.backends.map((e=>e.fileExtensions)).flat(),(e=>{e&&this.openFile(e).catch((e=>{console.error(e),DialogCreator.alert("An error occurred while loading the file.",{title:"Media Player - Error",icon:"error"})}))})).show()}},{type:"normal",label:"Close",onclick:()=>{this.closeFile()}},{type:"separator"},{type:"normal",label:"Exit",onclick:()=>{this.terminate()}}]),r.addRoot("Edit",[{type:"normal",label:"Copy Object",onclick:()=>{w96.wmem.clipboard.items=[this.currentFile],w96.wmem.clipboard.action="copy"}},{type:"separator"},{type:"normal",label:"Options",onclick:()=>{},disabled:!0},{type:"normal",label:"Selection...",onclick:()=>{},disabled:!0}]),r.addRoot("Device",[...this.constructor.backends.map(((e,t)=>({type:"normal",label:`${t+1} ${e.backendName}`,onclick:()=>{new OpenFileDialog("C:/user",e.fileExtensions,(e=>{e&&this.openFile(e).catch((e=>{console.error(e),DialogCreator.alert("An error occurred while loading the file.",{title:"Media Player - Error",icon:"error"})}))})).show()}}))),{type:"separator"},{type:"normal",label:"Properties",onclick:()=>{},disabled:!0},{type:"separator"},{type:"normal",label:"Volume Control",onclick:()=>{},disabled:!0}]),r.addRoot("Scale",[{type:"normal",label:"Time",onclick:()=>{}},{type:"normal",label:"Frames",onclick:()=>{}},{type:"normal",label:"Tracks",onclick:()=>{}}]),r.addRoot("Help",[{type:"normal",label:"Help Topics",onclick:()=>{},disabled:!0},{type:"separator"},{type:"normal",label:"About Media Player",onclick:()=>DialogCreator.alert('<span class="bold-noaa">MPlayer</span><br>Version 1.0<br>',{title:"About Media Player",icon:"info"})}]),t.querySelector(".mplayer-menubar").replaceWith(r.getMenuDiv()),this.mainwnd.show(),e[1]){if(!await this.openFile(e[1]))return;this.player.play()}}async openFile(e){this.closeFile();const t=FSUtil.getExtension(e).toLowerCase().substring(1),r=this.constructor.backends.find((e=>e.fileExtensions.includes(t)));if(!r)return DialogCreator.alert("Unsupported file type: "+t,{title:"Media Player - Error",icon:"error"}),!1;try{return this.mainwnd.setTitle(`Media Player - ${FSUtil.fname(e)} (loading)`),this.player=new r,this.player.onloaded=async()=>{this.mainwnd.setTitle(`Media Player - ${this.player.getName()} (stopped)`),this.thumb.style.left="";for(let e in this.buttons)this.buttons[e].disabled=!1;this.buttons.stop.disabled=!0,this.player.duration()<60?this.statusBar.value="0.00 (sec)":this.statusBar.value="00:00:00 (hrs:min:sec)";let e=this.player.getVideoElement();if(e){this.videownd=this.createWindow({title:"Media Player - Video",icon:await Theme.getIconUrl("apps/mplayer","16x16"),body:"",minWidth:320,minHeight:160,initialWidth:Math.min(640,e.videoWidth),initialHeight:Math.min(480,e.videoHeight),taskbar:!0},!1);let t=this.videownd.getBodyContainer();t.classList.add("mplayer-video"),t.appendChild(e),this.videownd.show()}},this.player.onplay=()=>{this.mainwnd.setTitle(`Media Player - ${this.player.getName()} (playing)`),this.buttons.playPause.children[0].src=this.resources.pause,this.player.time()||(this.buttons.stop.disabled=!1)},this.player.onpause=()=>{this.buttons.playPause.children[0].src=this.resources.play,this.mainwnd.setTitle(`Media Player - ${this.player.getName()} (paused)`),this.player.time()||(this.buttons.stop.disabled=!0)},this.player.onended=()=>{this.buttons.playPause.children[0].src=this.resources.play,this.mainwnd.setTitle(`Media Player - ${this.player.getName()} (stopped)`),this.buttons.stop.disabled=!0,this.player.time(0)},this.player.ondurationchange=e=>{},this.player.ontimeupdate=e=>{this.player&&(this.thumb.style.left=`calc(${e/this.player.duration()*100}% - 5px)`,this.player.duration()<60?this.statusBar.value=e.toFixed(2)+" (sec)":this.statusBar.value=this.secondsToString(e)+" (hrs:min:sec)")},this.player.onerror=e=>{DialogCreator.alert(e.message,{title:"Media Player - Error",icon:"error"}),this.closeFile()},await this.player.load(e),this.currentFile=e,!0}catch(e){return DialogCreator.alert(e.message,{title:"Media Player - Error",icon:"error"}),this.closeFile(),!1}}closeFile(){for(let e in this.buttons)this.buttons[e].disabled=!0;this.buttons.playPause.children[0].src=this.resources.play,this.mainwnd.setTitle("Media Player"),this.thumb.style.left="",this.statusBar.value="",this.player&&this.player.unload(),this.player=null,this.videownd&&(this.videownd.close(),this.videownd=null)}ontermination(){super.ontermination(),this.player&&this.player.unload(),this.player=null,this.revokeResources(),document.body.removeEventListener("mousemove",this._mouseMoveListener),document.body.removeEventListener("mouseup",this._mouseUpListener)}}_defineProperty(MPlayerApplication,"backends",[MPlayer_HTMLAudio,MPlayer_HTMLVideo]),_defineProperty(MPlayerApplication,"resources",{play:"W:/system/resource/app/mplayer/icons/play.png",pause:"W:/system/resource/app/mplayer/icons/pause.png",stop:"W:/system/resource/app/mplayer/icons/stop.png",eject:"W:/system/resource/app/mplayer/icons/eject.png",previousMark:"W:/system/resource/app/mplayer/icons/previousMark.png",rewind:"W:/system/resource/app/mplayer/icons/rewind.png",fastForward:"W:/system/resource/app/mplayer/icons/fastForward.png",nextMark:"W:/system/resource/app/mplayer/icons/nextMark.png",startSelection:"W:/system/resource/app/mplayer/icons/startSelection.png",endSelection:"W:/system/resource/app/mplayer/icons/endSelection.png",thumb:"W:/system/resource/app/mplayer/icons/thumb.png",thumbActive:"W:/system/resource/app/mplayer/icons/thumb-active.png"});

return await WApplication.execAsync(new MPlayerApplication(), this.boxedEnv.args, this);