//!wrt $BSPEC:{"icn":"apps/registry","cpr":"Copyright (C) Windows 96 Team 2023.","dsc":"System Configuration Manager","frn":"SysConfMgr","ver":1,"ssy":"gui"}

const StyleCSS={Main:".scm-app>.container {\n        flex: 1;\n        flex-direction: row;\n        display: flex;\n        overflow: hidden;\n        margin-bottom: 2px;\n    }\n    \n    .scm-app>.container>.item-view {\n        flex: 1;\n        height: 100%;\n        width: 100%;\n        box-sizing: border-box;\n        background: white;\n        overflow: auto;\n    }\n    \n    .scm-app>.container>.item-view>.shell-icon {\n        top: 2px;\n        left: 3px;\n    }\n    \n    .scm-app>.container>.item-view>.shell-icon>.icon-text {\n        color: black;\n        text-shadow: none;\n    }\n    \n    .scm-app>.container>.item-view>.shell-icon.selected>.icon-text\n    {\n        color: white;\n    }\n    \n    .scm-app>.container>.preview {\n        width: 200px;\n        white-space: pre-line;\n        padding: 5px;\n        box-sizing: border-box;\n        overflow: auto;\n    }\n    \n    .scm-app .w96-toolbar>.item {\n        min-width: 54px;\n    }\n    \n    .scm-app .w96-toolbar>.item[disabled] {\n        text-shadow: 1px 1px white;\n        color: rgb(109, 109, 109);\n    }\n    \n    .scm-app .w96-toolbar>.item[disabled]>.icon {\n        filter: contrast(0) drop-shadow(1px 1px #fff);\n    }\n    \n    .scm-app .w96-toolbar>.item>.icon {\n        background-position: center;\n        filter: grayscale(100%);\n    }\n    \n    .scm-app .w96-toolbar>.item:not([disabled]):hover>.icon {\n        filter: none;\n    }"},alphaSortFn=function(e,t){return e.getAttribute("name").toLowerCase()<t.getAttribute("name").toLowerCase()?-1:e.getAttribute("name").toLowerCase()>t.getAttribute("name").toLowerCase()?1:0};function isClass(e){return"function"==typeof e&&/^\s*class\s+/.test(e.toString())}function isAsyncFunction(e){return"function"==typeof e&&/^\s*async\s+/.test(e.toString())}function uiDelete(e,t){t.includes("/")&&!t.startsWith("/")&&e.selectedIcon&&DialogCreator.confirm(`Are you sure you want to delete '${t}'?`,{},(n=>{if(!n)return;SCM.remove(t)?(SCM.syncRoot(t.split("/")[0]),e.refreshView()):DialogCreator.alert(`Unable to delete '${t}'.`,{icon:"error"})}))}function uiNewKey(e,t){""!=t.trim()&&DialogCreator.prompt("Enter a new key name.<br><br>Please note that this should be alphanumeric, without spaces, for maximum compatibility.",{title:"Enter Key Name"},(n=>{if(!n||""==n.trim())return;const a=`${t}/${n}`;if(void 0!==SCM.get(a))return void DialogCreator.alert(`Unable to create '${a}': Item exists.`,{icon:"error"});SCM.get(t)[n]={},SCM.syncRoot(t.split("/")[0]),e.refreshView()}))}function uiNewValue(e,t="new-value",n=null){let a;const i=[{name:"oname",type:"textbox",caption:"Object Name"},{name:"ojson",type:"textbox",multiline:!0,caption:"JSON Value",value:"{}"}];switch(t){case"new-value":a="New Value",i[1].value="null";break;case"edit-value":a="Edit Value",i[0].value=n,i[1].value=JSON.stringify(SCM.get(`${e.currentPath}/${i[0].value}`));break;case"insert-json":a="Insert Json Value"}return DialogCreator.fieldset(i,{title:a,onvalidate:n=>{const a=n.find((e=>"oname"==e.name)),i=n.find((e=>"ojson"==e.name));if(""==a.value.trim())return alert("No object name has been provided.",{icon:"error"}),!1;if(a.value.includes("/"))return alert("An invalid object name has been provided.",{icon:"error"}),!1;if(""==i.value.trim())return alert("No JSON has been provided",{icon:"error"}),!1;const o=`${e.currentPath}/${a.value}`;if("edit-value"!==t&&void 0!==SCM.get(o))return DialogCreator.alert(`Unable to create '${o}': Item exists.`,{icon:"error"}),!1;try{JSON.parse(i.value)}catch(e){return alert("The specified JSON cannot be parsed.",{icon:"error"}),!1}return!0}},(async t=>{if(!t)return;const n=t.find((e=>"oname"==e.name)).value,a=t.find((e=>"ojson"==e.name)).value;SCM.get(e.currentPath)[n]=JSON.parse(a),await SCM.syncRoot(e.currentPath.split("/")[0]),e.refreshView()}))}const{Theme:Theme,MenuBar:MenuBar,DialogCreator:DialogCreator}=w96.ui,{ToolBar:ToolBar}=w96.ui.components,{sysConf:SCM}=w96;class SCMApp extends WApplication{constructor(){super(),this.currentPath="",this.state={toolsObjectMenuItems:[]}}async main(e){if(await super.main(e),!SCM.get("Software/SCM/UI/userWarningShown")){let e;const t=DialogCreator.confirm("The System Configuration Manager (SCM) is a system tool that has the potential to completely damage your system if used incorrectly!<br><br>Are you sure you want to continue?",{title:"SCM",icon:"warning"},(t=>e=t));if(await t.wait(),!e)return void this.terminate();SCM.setAndSync("Software/SCM/UI/userWarningShown",!0)}const t=this.createWindow({title:"<config root> - System Configuration Manager",icon:await Theme.getIconUrl("apps/registry","16x16"),body:`<div class="appbar"></div>\n            <div class="toolbar"></div>\n            <div class="container">\n                <div class="item-view w96-inset">\n\n                </div>\n                <div class="preview w96-inset"></div>\n            </div>\n            <footer class="w96-footer">\n                <div class="cell">\n                    (none)\n                </div>\n            </footer>\n            <style>\n                ${StyleCSS.Main}\n            </style>`,bodyClass:"scm-app",initialHeight:449,initialWidth:641,taskbar:!0},!0),n=t.getBodyContainer(),a=new MenuBar;a.addRoot("File",[{type:"normal",label:"Exit",onclick:()=>this.terminate()}]),a.addRoot("Tools",[{type:"submenu",label:"Object...",items:this.state.toolsObjectMenuItems=[{id:"fromJson",type:"normal",label:"From JSON",icon:await Theme.getIconUrl("actions/from-json","16x16"),onclick:()=>uiNewValue(this,"insert-json")},{type:"separator"},{id:"toJson",type:"normal",label:"To JSON",icon:await Theme.getIconUrl("actions/to-json","16x16"),onclick:()=>DialogCreator.fieldset([{type:"text",value:"JSON Data"},{type:"textbox",multiline:!0,value:JSON.stringify(SCM.get(`${this.currentPath}/${this.selectedIcon.getAttribute("name")}`)),attr:[{name:"readonly",value:""}]}],{title:`JSON for ${this.selectedIcon.getAttribute("name")}`,buttons:[{id:"ok",text:"OK",action:"$close"}]})},{id:"toString",type:"normal",label:"To String",icon:await Theme.getIconUrl("actions/to-string","16x16"),onclick:()=>DialogCreator.fieldset([{type:"text",value:"toString() Data"},{type:"textbox",multiline:!0,value:new String(SCM.get(`${this.currentPath}/${this.selectedIcon.getAttribute("name")}`)),attr:[{name:"readonly",value:""}]}],{title:`toString() for ${this.selectedIcon.getAttribute("name")}`,buttons:[{id:"ok",text:"OK",action:"$close"}]})}]}],!1),a.addRoot("Help",[{type:"normal",label:"About SCM...",onclick:async()=>DialogCreator.alert('<span class="bold-noaa">System Configuration Manager</span><br>Version 1.0<br><br>Copyright (C) Windows 96 Team 2023.',{icon:await Theme.getIconUrl("apps/registry","32x32"),title:"About SCM"})}]),n.querySelector(".appbar").replaceWith(a.getMenuDiv());const i=new ToolBar;i.addItem({name:"newKey",text:"New Key",imageUrl:await Theme.getIconUrl("places/folder","24x24"),onclick:()=>uiNewKey(this,this.currentPath)}),i.addItem({name:"newValue",text:"New Value",imageUrl:await Theme.getIconUrl("mime/bin-data","24x24"),onclick:()=>uiNewValue(this,"new-value")}),i.addSeparator(),i.addItem({name:"up",text:"Up",imageUrl:await Theme.getIconUrl("actions/up","24x24"),onclick:()=>{this.currentPath.includes("/")?this.navigate(this.currentPath.substring(0,this.currentPath.lastIndexOf("/"))):this.navigate("")}}),i.addItem({name:"delete",text:"Delete",imageUrl:await Theme.getIconUrl("actions/delete","24x24"),onclick:()=>{this.selectedIcon&&uiDelete(this,this.currentPath+"/"+this.selectedIcon.getAttribute("name"))}}),n.querySelector(".toolbar").replaceWith(i.getElement()),t.onshown=()=>{this.refreshView()};const o=t.getBodyContainer().querySelector(".item-view");o.addEventListener("click",(e=>{e.target==o&&(o.querySelectorAll(".selected").forEach((e=>e.classList.remove("selected"))),this.setPreviewText(""),this.selectedIcon=null,this.updateMbar())})),t.show(),this.mainwnd=t,this.toolbar=i}__disableAllItems(e,t=[]){for(let n of e)t.includes(n.id||"")?n.disabled=!1:n.disabled=!0}__enableAllItems(e,t=[]){for(let n of e)t.includes(n.id||"")?n.disabled=!0:n.disabled=!1}updateMbar(){this.__enableAllItems(this.state.toolsObjectMenuItems),""!=this.currentPath?this.selectedIcon||this.__disableAllItems(this.state.toolsObjectMenuItems,["fromJson"]):this.__disableAllItems(this.state.toolsObjectMenuItems)}updateToolbar(){this.toolbar.resetItemStates(),""==this.currentPath&&(this.toolbar.setDisabled("newKey",!0),this.toolbar.setDisabled("newValue",!0),this.toolbar.setDisabled("up",!0),this.toolbar.setDisabled("delete",!0))}createIcon(e,t){const n=this.mainwnd.getBodyContainer().querySelector(".item-view"),a=document.createElement("div");a.classList.add("shell-icon"),a.setAttribute("name",t),a.style.display="inline-flex",a.style.position="relative",a.style.flexDirection="column",a.addEventListener("click",(()=>{this.selectedIcon=a,n.querySelectorAll(".selected").forEach((e=>e.classList.remove("selected"))),a.classList.add("selected"),this.updateMbar()}));const i=document.createElement("div");i.classList.add("icon-image"),i.style.backgroundImage=`url(${e})`,a.appendChild(i);const o=document.createElement("div");return o.classList.add("icon-text"),o.textContent=t,a.appendChild(o),a}setPreviewText(e){this.mainwnd.getBodyContainer().querySelector(".preview").textContent=e}async navigate(e){this.setPreviewText(""),this.selectedIcon=null;const t=SCM.ls(e),n=this.mainwnd.getBodyContainer().querySelector(".item-view");for(;n.firstChild;)n.removeChild(n.firstChild);let a=[],i=[];for(let n of t){let t,o,r,s,l="";switch(n.type){case"root":t=this.createIcon(await Theme.getIconUrl("places/folder-locked","32x32"),n.name),t.addEventListener("click",(()=>this.setPreviewText(SCM.getIndex(n.name).description))),a.push(t),t.addEventListener("dblclick",(()=>this.navigate(n.name)));break;case"key":s=SCM.get(e+"/"+n.name),s instanceof Array?(l="Type: Array",o="objects/folder-array"):(l="Type: Key/Object",o="places/folder"),t=this.createIcon(await Theme.getIconUrl(o,"32x32"),n.name),a.push(t),t.addEventListener("dblclick",(()=>this.navigate(this.currentPath+"/"+n.name))),t.addEventListener("click",(()=>this.setPreviewText(l)));break;case"value":try{s=SCM.get(e+"/"+n.name)}catch(e){s=null}switch(r=typeof s,r){default:o="mime/bin-data",l="Type: Unknown";break;case"function":if(isClass(s))l="Type: Class",o="objects/object-class";else if(isAsyncFunction(s))l="Type: Asynchronous Function",o="objects/fn-async";else if("toString"==n.name){let e;try{e=s()}catch(t){e="<toString() failure>"}l=`Type: ToString function\nLength: ${e.length}\nValue: ${e.length>200?"<String truncated>":e}`,o="objects/fn-tostring"}else l="Type: Function",o="objects/bin-data-exec";break;case"string":o="mime/str-data",l=`Type: String\nLength: ${s.length}\nValue: ${s.length>200?"<String truncated>":s}`;break;case"number":o="objects/numbers",l=`Value: ${s}`;break;case"boolean":o="objects/object-bool",l=`Value: ${s}`;break;case"object":if(null!==s)break;o="objects/object-null",l="Value: Null";break;case"undefined":o="objects/object-null-2",l="Value: Undefined"}try{t=this.createIcon(await Theme.getIconUrl(o,"32x32"),n.name),i.push(t),isClass(s)&&t.addEventListener("dblclick",(()=>this.navigate(this.currentPath+"/"+n.name))),t.addEventListener("click",(()=>this.setPreviewText(l))),t.addEventListener("dblclick",(()=>{switch(r){case"object":case"boolean":case"number":case"string":uiNewValue(this,"edit-value",n.name)}}))}catch(e){}}}for(let e of a)n.appendChild(e);for(let e of i)n.appendChild(e);a.sort(alphaSortFn),i.sort(alphaSortFn);const o=e=>{e.style.marginRight="3px",e.style.marginBottom="19px"};a.forEach(o),i.forEach(o),a=null,i=null,this.currentPath=e,this.mainwnd.setTitle(`${""==this.currentPath?"<config root>":FSUtil.fname(this.currentPath)} - System Configuration Manager`),this.mainwnd.getBodyContainer().querySelector("footer .cell").textContent=""==this.currentPath?"<config root>":this.currentPath,this.updateToolbar(),this.updateMbar()}async refreshView(){await this.navigate(this.currentPath)}async ontermination(){await super.ontermination(),this.mainwnd=null,this.toolbar=null}}

return await WApplication.execAsync(new SCMApp(), this.boxedEnv.args, this);