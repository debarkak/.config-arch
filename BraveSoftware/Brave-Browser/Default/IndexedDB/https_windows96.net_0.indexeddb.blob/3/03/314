//!wrt $BSPEC:{"icn":"apps/superterm","cpr":"Copyright (C) Windows 96 Team 2023.","dsc":"P3 Super Terminal","frn":"SuperTerm","ver":1,"ssy":"gui"}

const{utils:UIUtils,DialogCreator:DialogCreator,MenuBar:MenuBar,Theme:Theme}=w96.ui,{mkShortcut:mkShortcut}=w96.shell,RTOP_PORT=121;class SuperTermApplication extends WApplication{constructor(){super()}async main(t){super.main(t),this.p3=w96.net.p3,this.connection={address:null,name:null,socket:null};const e=t=>!!this.connection.socket,n=this.createWindow({initialWidth:520,initialHeight:350,title:"SuperTerm",taskbar:!0,bodyClass:"superterm",icon:await Theme.getIconUrl("apps/superterm","16x16"),controlBoxStyle:"WS_CBX_MINMAXCLOSE"},!0),i=new MenuBar;i.addRoot("File",[{type:"normal",label:"Create shortcut",onopened:e,onclick:()=>{mkShortcut(`c:/user/desktop/${this.connection.name}.link`,"apps/superterm",`superterm --connection ${this.connection.name}\n${this.connection.address}\n${this.el.term.style.color}\n${this.el.term.style.backgroundColor}`),DialogCreator.alert("Shortcut created on your desktop.",{title:"Create shortcut",icon:"info"})}},{type:"separator"},{type:"normal",label:"Exit",onclick:()=>{this.ontermination()}}]),i.addRoot("Connection",[{type:"normal",label:"New connection...",onclick:()=>{this._newConnectionDialog()}},{type:"separator"},{type:"normal",label:"Connect",onopened:t=>(t.textContent=this.connection.socket&&this.connection.socket.connected?"Disconnect":"Connect",e()),onclick:()=>{this.connection.socket.connected?this.disconnect(!0):this.reconnect()}},{type:"normal",label:"End",onopened:e,onclick:()=>{this.disconnect()}}]),i.addRoot("View",[{type:"normal",label:"Clear history",onclick:()=>{this.el.term.innerHTML=""}},{type:"separator"},{type:"submenu",label:"Color scheme...",items:[{type:"normal",label:"Green on black",onclick:()=>this.setTheme("#0f0","#000")},{type:"normal",label:"Black on white",onclick:()=>this.setTheme("#000","#fff")},{type:"normal",label:"Light blue on gray",onclick:()=>this.setTheme("#dff","#222")}]}],!1),i.addRoot("Help",[{type:"normal",label:"About",onclick:()=>{DialogCreator.alert('\n\t\t\t\t\t\t<span class="bold-noaa">SuperTerm</span><br>\n\t\t\t\t\t\t<span>Version 1.0</span>',{title:"About",icon:"info"})}}]);const o=n.getBodyContainer();o.innerHTML='\n\t\t\t<div class="appbar"></div>\n\t\t\t<div class="term w96-inset"></div>\n\t\t\t<input type="text" class="input w96-textbox" disabled>\n\t\t';let c=i.getMenuDiv();o.querySelector(".appbar").replaceWith(c);let s=document.createElement("div");if(s.classList.add("superterm-activity"),s.title="Input/Output",c.appendChild(s),this.wnd=n,this.el={term:o.querySelector(".term"),input:o.querySelector(".input"),activity:s},this.el.input.onkeydown=t=>{"Enter"==t.key&&this.connection.socket.connected&&(this.setActivityLight("input"),this.connection.socket.send(["input",this.el.input.value.trim()]),t.shiftKey||(this.el.input.value=""))},"--connection"===t[1]){let e=t.slice(1).join(" ").split("\n");this.connect(e[0],e[1]),this.setTheme(e[2],e[3])}this._updateTitle(),n.show()}setActivityLight(t){let e="#000";"input"==t&&(e="#0a0"),"output"==t&&(e="#a00");for(let t=0;t<2;t++)setTimeout((()=>{this.el.activity.style.background=e,setTimeout((()=>{this.el.activity.style.background=""}),150)}),200*t)}async _newConnectionDialog(){const t=this.createWindow({initialWidth:260,initialHeight:202,title:"New Connection",taskbar:!1,center:!0,bodyClass:"superterm",controlBoxStyle:"WS_CBX_CLOSE",resizable:!1},!1),e=t.getBodyContainer();e.innerHTML=`\n\t\t\t<div class="mbox">\n\t\t\t<div class="content">\n\t\t\t\t<div class="icon" style="background-image:url(${await Theme.getIconUrl("apps/superterm","normal")}"></div>\n\t\t\t\t<div class="text">Enter an RToP address and a name for the connection:</div>\n\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class="inputs">\n\t\t\t\t<span>Name:</span>\n\t\t\t\t<input type="text" class="input-name w96-textbox" value="New connection">\n\t\t\t\t<span>RToP address:</span>\n\t\t\t\t<input type="text" class="input-url w96-textbox" placeholder="address.ppp">\n\n\t\t\t\t<div class="separator w96-inset"></div>\n\t\t\t</div>\n\n\n\t\t\t<div class="buttons">\n\t\t\t\t<button class="w96-button btn-confirm" disabled>OK</button>\n\t\t\t\t<button class="w96-button btn-cancel">Cancel</button>\n\t\t\t</div>\n\t\t`;let n=t=>{i.value.trim()&&o.value.trim()?(c.removeAttribute("disabled"),"Enter"===t.key&&c.click()):c.setAttribute("disabled","true")},i=e.querySelector(".input-name"),o=e.querySelector(".input-url");i.onkeyup=n,o.onkeyup=n;let c=e.querySelector(".btn-confirm");c.onclick=()=>{let e=i.value.trim(),n=o.value.trim();this.connection.socket?DialogCreator.alert("Are you sure you want to create a new connection? Your current session will be terminated.",{buttons:[{id:"ok",text:"OK",action:({dlg:i})=>{i.close(),t.close(),this.connect(e,n)}},{id:"cancel",text:"Cancel",action:({dlg:t})=>{t.close()}}],title:"Confirm",icon:"question"}):(t.close(),this.connect(e,n))},e.querySelector(".btn-cancel").onclick=()=>{t.close()},t.show(),o.focus()}_updateTitle(){const{socket:t}=this.connection;this.appWindow&&(this.connection.name?t?this.wnd.setTitle(`${this.connection.name} (${t.connected?"connected":"disconnected"}) - SuperTerm`):this.wnd.setTitle(`${this.connection.name} (dialing) - SuperTerm`):this.wnd.setTitle("SuperTerm"))}_onmessage([t,e]){if(this.setActivityLight("output"),"text"===t){if(e instanceof Array&&e.forEach((t=>{let e=document.createElement("span");var n;"object"==typeof t&&(e.style.color=t.color,e.style.backgroundColor=t.background,e.textContent=null!==(n=t.text)&&void 0!==n?n:"","string"==typeof t.onclick&&(e.onclick=()=>{this.connection.socket.connected&&(this.setActivityLight("input"),this.connection.socket.send(["click",t.onclick]))},e.classList.add("clickable")));"string"==typeof t&&(e.textContent=t),this.el.term.appendChild(e)})),"string"==typeof e){let t=document.createElement("span");t.textContent=e,this.el.term.appendChild(t)}return this.el.term.scrollTop=this.el.term.scrollHeight}if("resize"==t){const{clientWidth:t,clientHeight:n}=document.body;let[i,o]=e;if(isNaN(i)||isNaN(o))return;return i>t&&(i=t),o>n&&(o=n),this.wnd.setSize(parseInt(i,10),parseInt(o,10))}return"clear"==t?this.el.term.innerHTML="":"focus"==t?this.el.input.focus():void 0}async connect(t,e){let n;this.connection.socket&&this.connection.socket.disconnect();let i=new URL(`http://${e}`);if(i.port||(i.port=121,e=i.host),this.connection={name:t,address:e,socket:null},this.el.term.innerHTML="",this._updateTitle(),!this.p3.connected&&!await UIUtils.p3Connect())return this.connection.name=null,void(this.connection.address=null);n=this.p3.createConnection(e),this.connection.socket=n,n.on("message",(t=>this._onmessage(t))),n.on("disconnect",(()=>{this._updateTitle(),this.el.input.setAttribute("disabled","true")}));try{await n.connect(),this.el.input.removeAttribute("disabled"),this._updateTitle()}catch(t){DialogCreator.alert(`Error while connecting to ${this.connection.address}:\n${t.toString()}`,{title:"Error",icon:"error"}),this._updateTitle()}}disconnect(t=!1,e=!0){this.connection.socket&&this.connection.socket.connected&&this.connection.socket.disconnect(),t||(this.connection.name=null,this.connection.address=null,this.connection.socket=null),e&&this._updateTitle()}setTheme(t,e){this.el.term.style.color=t,this.el.term.style.backgroundColor=e}async reconnect(){if(this.connection.socket)return await this.connect(this.connection.name,this.connection.address)}ontermination(){super.ontermination(),this.disconnect(!0,!1)}}

return await WApplication.execAsync(new SuperTermApplication(), this.boxedEnv.args, this);